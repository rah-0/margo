package template

import (
	"path/filepath"
	"strings"

	"github.com/rah-0/nabu"

	"github.com/rah-0/margo/conf"
	"github.com/rah-0/margo/db"
	"github.com/rah-0/margo/util"
)

func CreateGoFileEntity(rawTableName string, tfs []conf.TableField, nqs []conf.NamedQuery) error {
	p := filepath.Join(conf.Args.OutputPath, db.NormalizeString(conf.Args.DBName), db.NormalizeString(rawTableName), "entity.go")
	c, err := GetFileContentEntity(rawTableName, tfs, nqs)
	if err != nil {
		return nabu.FromError(err).WithArgs(rawTableName).Log()
	}

	return util.WriteGoFile(p, c)
}

func GetFileContentEntity(rawTableName string, tfs []conf.TableField, nqs []conf.NamedQuery) (string, error) {
	t := "package " + db.NormalizeString(rawTableName) + "\n\n"
	t += GetCommentWarning()
	t += GetImports(nqs)
	t += GetConsts(rawTableName, tfs)
	t += GetVars(tfs, nqs)
	t += GetStruct(tfs)
	t += GetGeneralFunctions(tfs, nqs)
	t += GetDBFunctions()
	t += GetNamedQueryFunctions(nqs)

	return t, nil
}

func GetCommentWarning() string {
	return `// ---------------------------------------------------------------
// The code in this file is autogenerated, do not modify manually!
// ---------------------------------------------------------------

`
}

func GetImports(nqs []conf.NamedQuery) string {
	imports := "import (\n"
	imports += `"context"` + "\n"
	imports += `"database/sql"` + "\n"
	if len(nqs) > 0 {
		imports += `"encoding/base64"` + "\n"
	}
	imports += `"errors"` + "\n"
	imports += `"strings"` + "\n"
	imports += `"sync"` + "\n"
	imports += ")\n\n"
	return imports
}

func GetConsts(rawTableName string, tfs []conf.TableField) string {
	t := "const (\n"
	t += `FQTN = "` + "`" + conf.Args.DBName + "`.`" + rawTableName + "`" + `"` + "\n"
	for _, tf := range tfs {
		t += "Field" + db.NormalizeString(tf.Name) + " = " + `"` + tf.Name + `"` + "\n"
	}
	t += ")\n\n"
	return t
}

func GetVars(tfs []conf.TableField, nqs []conf.NamedQuery) string {
	var fieldList []string
	for _, tf := range tfs {
		fieldList = append(fieldList, "Field"+db.NormalizeString(tf.Name))
	}

	t := "var (\n"
	t += "Fields = []string{" + strings.Join(fieldList, ",") + "}\n"
	t += "db *sql.DB\n"
	t += "stmtMu sync.RWMutex\n"
	t += "stmtCache = make(map[string]*sql.Stmt)\n"
	if len(nqs) > 0 {
		t += "queries = map[string]*NamedQuery{\n"
		for _, nq := range nqs {
			t += `"` + nq.Name + `": {QueryEncoded: "` + nq.QueryEncoded + `"},` + "\n"
		}
		t += "}\n"
	}
	t += ")\n\n"

	if len(nqs) > 0 {
		t += "type NamedQuery struct {\n"
		t += "\tName string\n"
		t += "\tQuery string\n"
		t += "\tQueryEncoded string\n"
		t += "}\n\n"
	}

	return t
}

func GetStruct(tfs []conf.TableField) string {
	t := "type Entity struct {\n"
	for _, tf := range tfs {
		t += db.NormalizeString(tf.Name) + " string `json:\",omitempty,omitzero\"`\n"
	}
	t += "}\n\n"

	// QueryParams struct with builder methods
	t += "type QueryParams struct {\n"
	t += "	Select []string\n"
	t += "	Where  []string\n"
	t += "	Insert []string\n"
	t += "	Update []string\n"
	t += "	Params []any\n"
	t += "}\n\n"

	t += "func NewQueryParams() *QueryParams {\n"
	t += "	return &QueryParams{}\n"
	t += "}\n\n"

	t += "func (qp *QueryParams) WithSelect(fields ...string) *QueryParams {\n"
	t += "	qp.Select = fields\n"
	t += "	return qp\n"
	t += "}\n\n"

	t += "func (qp *QueryParams) WithWhere(fields ...string) *QueryParams {\n"
	t += "	qp.Where = fields\n"
	t += "	return qp\n"
	t += "}\n\n"

	t += "func (qp *QueryParams) WithInsert(fields ...string) *QueryParams {\n"
	t += "	qp.Insert = fields\n"
	t += "	return qp\n"
	t += "}\n\n"

	t += "func (qp *QueryParams) WithUpdate(fields ...string) *QueryParams {\n"
	t += "	qp.Update = fields\n"
	t += "	return qp\n"
	t += "}\n\n"

	t += "func (qp *QueryParams) WithParams(params ...any) *QueryParams {\n"
	t += "	qp.Params = params\n"
	t += "	return qp\n"
	t += "}\n\n"

	// QueryResult struct
	t += "type QueryResult struct {\n"
	t += "	Entities []*Entity\n"
	t += "	Entity   *Entity\n"
	t += "	Error    error\n"
	t += "	Result   sql.Result\n"
	t += "	Exists   bool\n"
	t += "}\n\n"

	return t
}

func GetGeneralFunctions(tfs []conf.TableField, nqs []conf.NamedQuery) string {
	t := "func SetDB(x *sql.DB) error {\n"
	t += "	db = x\n"
	if len(nqs) > 0 {
		t += "    for _, q := range queries {\n"
		t += "        b, err := base64.StdEncoding.DecodeString(q.QueryEncoded)\n"
		t += "        if err != nil {\n"
		t += "            return err\n"
		t += "        }\n"
		t += "        q.Query = string(b)\n"
		t += "    }\n"
	}
	t += "    return nil\n"
	t += "}\n\n"

	t += "func (x *Entity) GetFieldValue(field string) any {\n"
	t += "	switch field {\n"
	for _, tf := range tfs {
		tfn := db.NormalizeString(tf.Name)
		t += "	case Field" + tfn + ":\n"
		t += "		return x." + tfn + "\n"
	}
	t += "	}\n"
	t += "	return nil\n"
	t += "}\n\n"

	t += "func (x *Entity) GetFieldsValues(fieldList []string) []any {\n"
	t += "	values := make([]any, 0, len(fieldList))\n"
	t += "	for _, field := range fieldList {\n"
	t += "		values = append(values, x.GetFieldValue(field))\n"
	t += "	}\n"
	t += "	return values\n"
	t += "}\n\n"

	t += "func GetValuePlaceholder(field string) string {\n"
	t += "	switch field {\n"
	for _, tf := range tfs {
		tfn := db.NormalizeString(tf.Name)
		t += "	case Field" + tfn + ":\n"
		t += "		return \"?\"\n"
	}
	t += "	}\n"
	t += "	return \"\"\n"
	t += "}\n\n"

	t += "func GetValuesPlaceholders(fieldList []string) []string {\n"
	t += "	placeholders := make([]string, 0, len(fieldList))\n"
	t += "	for _, field := range fieldList {\n"
	t += "		placeholders = append(placeholders, GetValuePlaceholder(field))\n"
	t += "	}\n"
	t += "	return placeholders\n"
	t += "}\n\n"

	t += "func GetQualifiedField(field string) string {\n"
	t += "	switch field {\n"
	for _, tf := range tfs {
		tfn := db.NormalizeString(tf.Name)
		t += "	case Field" + tfn + ":\n"
		t += "		return FQTN + \".`\" + Field" + tfn + " + \"`\"\n"
	}
	t += "	}\n"
	t += "	return \"\"\n"
	t += "}\n\n"

	t += "func GetQualifiedFields(fieldList []string) []string {\n"
	t += "	fields := make([]string, 0, len(fieldList))\n"
	t += "	for _, field := range fieldList {\n"
	t += "		fields = append(fields, GetQualifiedField(field))\n"
	t += "	}\n"
	t += "	return fields\n"
	t += "}\n\n"

	t += "func GetQualifiedPlaceholder(field string) string {\n"
	t += "	switch field {\n"
	for _, tf := range tfs {
		tfn := db.NormalizeString(tf.Name)
		t += "	case Field" + tfn + ":\n"
		t += "		return FQTN + \".`\" + Field" + tfn + " + \"` = ?\"\n"
	}
	t += "	}\n"
	t += "	return \"\"\n"
	t += "}\n\n"

	t += "func GetQualifiedPlaceholders(fieldList []string) []string {\n"
	t += "	placeholders := make([]string, 0, len(fieldList))\n"
	t += "	for _, field := range fieldList {\n"
	t += "		placeholders = append(placeholders, GetQualifiedPlaceholder(field))\n"
	t += "	}\n"
	t += "	return placeholders\n"
	t += "}\n\n"

	t += "func getPreparedStmt(query string) (*sql.Stmt, error) {\n"
	t += "	stmtMu.RLock()\n"
	t += "	if stmt, ok := stmtCache[query]; ok {\n"
	t += "		stmtMu.RUnlock()\n"
	t += "		return stmt, nil\n"
	t += "	}\n"
	t += "	stmtMu.RUnlock()\n\n"
	t += "	stmtMu.Lock()\n"
	t += "	defer stmtMu.Unlock()\n"
	t += "	if stmt, ok := stmtCache[query]; ok {\n"
	t += "		return stmt, nil\n"
	t += "	}\n"
	t += "	stmt, err := db.Prepare(query)\n"
	t += "	if err != nil {\n"
	t += "		return nil, err\n"
	t += "	}\n"
	t += "	stmtCache[query] = stmt\n"
	t += "	return stmt, nil\n"
	t += "}\n\n"

	t += "func scanRow(fields []string, rows *sql.Rows) (*Entity, error) {\n"
	t += "	x := &Entity{}\n"
	t += "	var (\n"
	for _, tf := range tfs {
		t += "		ptr" + db.NormalizeString(tf.Name) + " *string\n"
	}
	t += "		scanTargets []any\n"
	t += "	)\n\n"
	t += "	for _, field := range fields {\n"
	t += "		switch field {\n"
	for _, tf := range tfs {
		tfn := db.NormalizeString(tf.Name)
		t += "		case Field" + tfn + ":\n"
		t += "			scanTargets = append(scanTargets, &ptr" + tfn + ")\n"
	}
	t += "		}\n"
	t += "	}\n\n"
	t += "	err := rows.Scan(scanTargets...)\n"
	t += "	if err != nil {\n"
	t += "		return nil, err\n"
	t += "	}\n\n"
	for _, tf := range tfs {
		tfn := db.NormalizeString(tf.Name)
		t += "	if ptr" + tfn + " != nil {\n"
		t += "		x." + tfn + " = *ptr" + tfn + "\n"
		t += "	} else {\n"
		t += "		x." + tfn + " = \"\"\n"
		t += "	}\n"
	}
	t += "	return x, nil\n"
	t += "}\n\n"

	t += "func readRows(fields []string, rows *sql.Rows) ([]*Entity, error) {\n"
	t += "    defer rows.Close()\n"
	t += "    var results []*Entity\n"
	t += "    for rows.Next() {\n"
	t += "        x, err := scanRow(fields, rows)\n"
	t += "        if err != nil { return results, err }\n"
	t += "        results = append(results, x)\n"
	t += "    }\n"
	t += "    if err := rows.Err(); err != nil { return results, err }\n"
	t += "    return results, nil\n"
	t += "}\n\n"

	t += "func bindStmtCtxTx(base *sql.Stmt, ctx context.Context, tx *sql.Tx) (*sql.Stmt, bool) {\n"
	t += "	if tx == nil {\n"
	t += "		return base, false\n"
	t += "	}\n"
	t += "	if ctx != nil {\n"
	t += "		return tx.StmtContext(ctx, base), true\n"
	t += "	}\n"
	t += "	return tx.Stmt(base), true\n"
	t += "}\n\n"

	t += "func execCore(ctx context.Context, tx *sql.Tx, query string, args ...any) (res sql.Result, err error) {\n"
	t += "	stmt, err := getPreparedStmt(query)\n"
	t += "	if err != nil { return nil, err }\n"
	t += "	s, needClose := bindStmtCtxTx(stmt, ctx, tx)\n"
	t += "	if needClose { defer func(){ if cerr := s.Close(); err == nil && cerr != nil { err = cerr } }() }\n"
	t += "	if ctx != nil { return s.ExecContext(ctx, args...) }\n"
	t += "	return s.Exec(args...)\n"
	t += "}\n\n"

	t += "func queryCore(ctx context.Context, tx *sql.Tx, fields []string, query string, args ...any) (out []*Entity, err error) {\n"
	t += "    stmt, err := getPreparedStmt(query)\n"
	t += "    if err != nil { return nil, err }\n"
	t += "    s, needClose := bindStmtCtxTx(stmt, ctx, tx)\n"
	t += "    if needClose { defer func(){ if cerr := s.Close(); err == nil && cerr != nil { err = cerr } }() }\n"
	t += "    var rows *sql.Rows\n"
	t += "    if ctx != nil { rows, err = s.QueryContext(ctx, args...) } else { rows, err = s.Query(args...) }\n"
	t += "    if err != nil { return nil, err }\n"
	t += "    return readRows(fields, rows)\n"
	t += "}\n\n"

	t += "func queryOneCore(ctx context.Context, tx *sql.Tx, fields []string, query string, args ...any) (*Entity, error) {\n"
	t += "    stmt, err := getPreparedStmt(query)\n"
	t += "    if err != nil { return nil, err }\n"
	t += "    s, needClose := bindStmtCtxTx(stmt, ctx, tx)\n"
	t += "    if needClose { defer s.Close() }\n"
	t += "    var rows *sql.Rows\n"
	t += "    if ctx != nil { rows, err = s.QueryContext(ctx, args...) } else { rows, err = s.Query(args...) }\n"
	t += "    if err != nil { return nil, err }\n"
	t += "    defer rows.Close()\n"
	t += "    if !rows.Next() { return nil, nil }\n"
	t += "    return scanRow(fields, rows)\n"
	t += "}\n\n"

	t += "func scalarCore(ctx context.Context, tx *sql.Tx, query string, args ...any) (int, error) {\n"
	t += "	stmt, err := getPreparedStmt(query)\n"
	t += "	if err != nil { return 0, err }\n"
	t += "	s, needClose := bindStmtCtxTx(stmt, ctx, tx)\n"
	t += "	if needClose { defer s.Close() }\n"
	t += "	var v int\n"
	t += "	if ctx != nil { err = s.QueryRowContext(ctx, args...).Scan(&v) } else { err = s.QueryRow(args...).Scan(&v) }\n"
	t += "	return v, err\n"
	t += "}\n\n"

	return t
}

func GetDBFunctions() string {
	t := ""

	t += "func DBTruncate() *QueryResult { res, err := execCore(nil, nil, \"TRUNCATE TABLE \"+FQTN); return &QueryResult{Result: res, Error: err} }\n"
	t += "func DBTruncateCtx(ctx context.Context) *QueryResult { res, err := execCore(ctx, nil, \"TRUNCATE TABLE \"+FQTN); return &QueryResult{Result: res, Error: err} }\n"
	t += "func DBTruncateTx(tx *sql.Tx) *QueryResult { res, err := execCore(nil, tx, \"TRUNCATE TABLE \"+FQTN); return &QueryResult{Result: res, Error: err} }\n"
	t += "func DBTruncateCtxTx(ctx context.Context, tx *sql.Tx) *QueryResult { res, err := execCore(ctx, tx, \"TRUNCATE TABLE \"+FQTN); return &QueryResult{Result: res, Error: err} }\n\n"

	t += "func (x *Entity) DBInsert(params *QueryParams) *QueryResult {\n"
	t += "	fieldsToInsert := Fields\n"
	t += "	if params != nil && len(params.Insert) > 0 { fieldsToInsert = params.Insert }\n"
	t += "	q := \"INSERT INTO \" + FQTN + \" (\" + strings.Join(GetQualifiedFields(fieldsToInsert), \", \") + \") VALUES (\" + strings.Join(GetValuesPlaceholders(fieldsToInsert), \", \") + \")\"\n"
	t += "	res, err := execCore(nil, nil, q, x.GetFieldsValues(fieldsToInsert)...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBInsertCtx(ctx context.Context, params *QueryParams) *QueryResult {\n"
	t += "	fieldsToInsert := Fields\n"
	t += "	if params != nil && len(params.Insert) > 0 { fieldsToInsert = params.Insert }\n"
	t += "	q := \"INSERT INTO \" + FQTN + \" (\" + strings.Join(GetQualifiedFields(fieldsToInsert), \", \") + \") VALUES (\" + strings.Join(GetValuesPlaceholders(fieldsToInsert), \", \") + \")\"\n"
	t += "	res, err := execCore(ctx, nil, q, x.GetFieldsValues(fieldsToInsert)...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBInsertTx(tx *sql.Tx, params *QueryParams) *QueryResult {\n"
	t += "	fieldsToInsert := Fields\n"
	t += "	if params != nil && len(params.Insert) > 0 { fieldsToInsert = params.Insert }\n"
	t += "	q := \"INSERT INTO \" + FQTN + \" (\" + strings.Join(GetQualifiedFields(fieldsToInsert), \", \") + \") VALUES (\" + strings.Join(GetValuesPlaceholders(fieldsToInsert), \", \") + \")\"\n"
	t += "	res, err := execCore(nil, tx, q, x.GetFieldsValues(fieldsToInsert)...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBInsertCtxTx(ctx context.Context, tx *sql.Tx, params *QueryParams) *QueryResult {\n"
	t += "	fieldsToInsert := Fields\n"
	t += "	if params != nil && len(params.Insert) > 0 { fieldsToInsert = params.Insert }\n"
	t += "	q := \"INSERT INTO \" + FQTN + \" (\" + strings.Join(GetQualifiedFields(fieldsToInsert), \", \") + \") VALUES (\" + strings.Join(GetValuesPlaceholders(fieldsToInsert), \", \") + \")\"\n"
	t += "	res, err := execCore(ctx, tx, q, x.GetFieldsValues(fieldsToInsert)...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"

	// DELETE with WHERE (AND conditions)
	t += "func (x *Entity) DBDelete(params *QueryParams) *QueryResult {\n"
	t += "	whereFields := Fields\n"
	t += "	if params != nil && len(params.Where) > 0 { whereFields = params.Where }\n"
	t += "	q := \"DELETE FROM \" + FQTN + \" WHERE \" + strings.Join(GetQualifiedFields(whereFields), \" = ? AND \") + \" = ?\"\n"
	t += "	res, err := execCore(nil, nil, q, x.GetFieldsValues(whereFields)...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBDeleteCtx(ctx context.Context, params *QueryParams) *QueryResult {\n"
	t += "	whereFields := Fields\n"
	t += "	if params != nil && len(params.Where) > 0 { whereFields = params.Where }\n"
	t += "	q := \"DELETE FROM \" + FQTN + \" WHERE \" + strings.Join(GetQualifiedFields(whereFields), \" = ? AND \") + \" = ?\"\n"
	t += "	res, err := execCore(ctx, nil, q, x.GetFieldsValues(whereFields)...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBDeleteTx(tx *sql.Tx, params *QueryParams) *QueryResult {\n"
	t += "	whereFields := Fields\n"
	t += "	if params != nil && len(params.Where) > 0 { whereFields = params.Where }\n"
	t += "	q := \"DELETE FROM \" + FQTN + \" WHERE \" + strings.Join(GetQualifiedFields(whereFields), \" = ? AND \") + \" = ?\"\n"
	t += "	res, err := execCore(nil, tx, q, x.GetFieldsValues(whereFields)...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBDeleteCtxTx(ctx context.Context, tx *sql.Tx, params *QueryParams) *QueryResult {\n"
	t += "	whereFields := Fields\n"
	t += "	if params != nil && len(params.Where) > 0 { whereFields = params.Where }\n"
	t += "	q := \"DELETE FROM \" + FQTN + \" WHERE \" + strings.Join(GetQualifiedFields(whereFields), \" = ? AND \") + \" = ?\"\n"
	t += "	res, err := execCore(ctx, tx, q, x.GetFieldsValues(whereFields)...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"

	// UPDATE with SET and WHERE (AND conditions)
	t += "func (x *Entity) DBUpdate(params *QueryParams) *QueryResult {\n"
	t += "	if params == nil || len(params.Update) == 0 || len(params.Where) == 0 {\n"
	t += "		return &QueryResult{Error: errors.New(\"DBUpdate requires both params.Update and params.Where to be specified\")}\n"
	t += "	}\n"
	t += "	q := \"UPDATE \" + FQTN + \" SET \" + strings.Join(GetQualifiedPlaceholders(params.Update), \", \") + \" WHERE \" + strings.Join(GetQualifiedFields(params.Where), \" = ? AND \") + \" = ?\"\n"
	t += "	vals := append(x.GetFieldsValues(params.Update), x.GetFieldsValues(params.Where)...)\n"
	t += "	res, err := execCore(nil, nil, q, vals...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBUpdateCtx(ctx context.Context, params *QueryParams) *QueryResult {\n"
	t += "	if params == nil || len(params.Update) == 0 || len(params.Where) == 0 {\n"
	t += "		return &QueryResult{Error: errors.New(\"DBUpdate requires both params.Update and params.Where to be specified\")}\n"
	t += "	}\n"
	t += "	q := \"UPDATE \" + FQTN + \" SET \" + strings.Join(GetQualifiedPlaceholders(params.Update), \", \") + \" WHERE \" + strings.Join(GetQualifiedFields(params.Where), \" = ? AND \") + \" = ?\"\n"
	t += "	vals := append(x.GetFieldsValues(params.Update), x.GetFieldsValues(params.Where)...)\n"
	t += "	res, err := execCore(ctx, nil, q, vals...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBUpdateTx(tx *sql.Tx, params *QueryParams) *QueryResult {\n"
	t += "	if params == nil || len(params.Update) == 0 || len(params.Where) == 0 {\n"
	t += "		return &QueryResult{Error: errors.New(\"DBUpdate requires both params.Update and params.Where to be specified\")}\n"
	t += "	}\n"
	t += "	q := \"UPDATE \" + FQTN + \" SET \" + strings.Join(GetQualifiedPlaceholders(params.Update), \", \") + \" WHERE \" + strings.Join(GetQualifiedFields(params.Where), \" = ? AND \") + \" = ?\"\n"
	t += "	vals := append(x.GetFieldsValues(params.Update), x.GetFieldsValues(params.Where)...)\n"
	t += "	res, err := execCore(nil, tx, q, vals...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBUpdateCtxTx(ctx context.Context, tx *sql.Tx, params *QueryParams) *QueryResult {\n"
	t += "	if params == nil || len(params.Update) == 0 || len(params.Where) == 0 {\n"
	t += "		return &QueryResult{Error: errors.New(\"DBUpdate requires both params.Update and params.Where to be specified\")}\n"
	t += "	}\n"
	t += "	q := \"UPDATE \" + FQTN + \" SET \" + strings.Join(GetQualifiedPlaceholders(params.Update), \", \") + \" WHERE \" + strings.Join(GetQualifiedFields(params.Where), \" = ? AND \") + \" = ?\"\n"
	t += "	vals := append(x.GetFieldsValues(params.Update), x.GetFieldsValues(params.Where)...)\n"
	t += "	res, err := execCore(ctx, tx, q, vals...)\n"
	t += "	return &QueryResult{Result: res, Error: err}\n"
	t += "}\n\n"

	// SELECT with optional WHERE and custom fields
	t += "func (x *Entity) DBSelect(params *QueryParams) *QueryResult {\n"
	t += "	fieldsToSelect := Fields\n"
	t += "	if params != nil && len(params.Select) > 0 { fieldsToSelect = params.Select }\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(fieldsToSelect), \", \") + \" FROM \" + FQTN\n"
	t += "	var args []any\n"
	t += "	if params != nil && len(params.Where) > 0 {\n"
	t += "		q += \" WHERE \" + strings.Join(GetQualifiedFields(params.Where), \" = ? AND \") + \" = ?\"\n"
	t += "		args = x.GetFieldsValues(params.Where)\n"
	t += "	}\n"
	t += "	entities, err := queryCore(nil, nil, fieldsToSelect, q, args...)\n"
	t += "	return &QueryResult{Entities: entities, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBSelectCtx(ctx context.Context, params *QueryParams) *QueryResult {\n"
	t += "	fieldsToSelect := Fields\n"
	t += "	if params != nil && len(params.Select) > 0 { fieldsToSelect = params.Select }\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(fieldsToSelect), \", \") + \" FROM \" + FQTN\n"
	t += "	var args []any\n"
	t += "	if params != nil && len(params.Where) > 0 {\n"
	t += "		q += \" WHERE \" + strings.Join(GetQualifiedFields(params.Where), \" = ? AND \") + \" = ?\"\n"
	t += "		args = x.GetFieldsValues(params.Where)\n"
	t += "	}\n"
	t += "	entities, err := queryCore(ctx, nil, fieldsToSelect, q, args...)\n"
	t += "	return &QueryResult{Entities: entities, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBSelectTx(tx *sql.Tx, params *QueryParams) *QueryResult {\n"
	t += "	fieldsToSelect := Fields\n"
	t += "	if params != nil && len(params.Select) > 0 { fieldsToSelect = params.Select }\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(fieldsToSelect), \", \") + \" FROM \" + FQTN\n"
	t += "	var args []any\n"
	t += "	if params != nil && len(params.Where) > 0 {\n"
	t += "		q += \" WHERE \" + strings.Join(GetQualifiedFields(params.Where), \" = ? AND \") + \" = ?\"\n"
	t += "		args = x.GetFieldsValues(params.Where)\n"
	t += "	}\n"
	t += "	entities, err := queryCore(nil, tx, fieldsToSelect, q, args...)\n"
	t += "	return &QueryResult{Entities: entities, Error: err}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBSelectCtxTx(ctx context.Context, tx *sql.Tx, params *QueryParams) *QueryResult {\n"
	t += "	fieldsToSelect := Fields\n"
	t += "	if params != nil && len(params.Select) > 0 { fieldsToSelect = params.Select }\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(fieldsToSelect), \", \") + \" FROM \" + FQTN\n"
	t += "	var args []any\n"
	t += "	if params != nil && len(params.Where) > 0 {\n"
	t += "		q += \" WHERE \" + strings.Join(GetQualifiedFields(params.Where), \" = ? AND \") + \" = ?\"\n"
	t += "		args = x.GetFieldsValues(params.Where)\n"
	t += "	}\n"
	t += "	entities, err := queryCore(ctx, tx, fieldsToSelect, q, args...)\n"
	t += "	return &QueryResult{Entities: entities, Error: err}\n"
	t += "}\n\n"

	// SelectAll - convenience function for selecting all rows with all fields
	t += "func DBSelectAll() *QueryResult {\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(Fields), \", \") + \" FROM \" + FQTN\n"
	t += "	entities, err := queryCore(nil, nil, Fields, q)\n"
	t += "	return &QueryResult{Entities: entities, Error: err}\n"
	t += "}\n\n"
	t += "func DBSelectAllCtx(ctx context.Context) *QueryResult {\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(Fields), \", \") + \" FROM \" + FQTN\n"
	t += "	entities, err := queryCore(ctx, nil, Fields, q)\n"
	t += "	return &QueryResult{Entities: entities, Error: err}\n"
	t += "}\n\n"
	t += "func DBSelectAllTx(tx *sql.Tx) *QueryResult {\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(Fields), \", \") + \" FROM \" + FQTN\n"
	t += "	entities, err := queryCore(nil, tx, Fields, q)\n"
	t += "	return &QueryResult{Entities: entities, Error: err}\n"
	t += "}\n\n"
	t += "func DBSelectAllCtxTx(ctx context.Context, tx *sql.Tx) *QueryResult {\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(Fields), \", \") + \" FROM \" + FQTN\n"
	t += "	entities, err := queryCore(ctx, tx, Fields, q)\n"
	t += "	return &QueryResult{Entities: entities, Error: err}\n"
	t += "}\n\n"



	//Exists - flexible: Select controls returned fields, Where controls filter
	t += "func (x *Entity) DBExists(params *QueryParams) *QueryResult {\n"
	t += "	if params == nil {\n"
	t += "		return &QueryResult{Error: errors.New(\"DBExists requires params to be specified\"), Exists: false}\n"
	t += "	}\n"
	t += "	fieldsToSelect := params.Select\n"
	t += "	if len(fieldsToSelect) == 0 { fieldsToSelect = Fields }\n"
	t += "	whereFields := params.Where\n"
	t += "	if len(whereFields) == 0 { whereFields = Fields }\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(fieldsToSelect), \", \") + \" FROM \" + FQTN + \" WHERE \" + strings.Join(GetQualifiedFields(whereFields), \" = ? AND \") + \" = ? LIMIT 1\"\n"
	t += "	entities, err := queryCore(nil, nil, fieldsToSelect, q, x.GetFieldsValues(whereFields)...)\n"
	t += "	if err != nil { return &QueryResult{Error: err, Exists: false} }\n"
	t += "	if len(entities) == 0 { return &QueryResult{Exists: false} }\n"
	t += "	*x = *entities[0]\n"
	t += "	return &QueryResult{Exists: true}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBExistsCtx(ctx context.Context, params *QueryParams) *QueryResult {\n"
	t += "	if params == nil {\n"
	t += "		return &QueryResult{Error: errors.New(\"DBExists requires params to be specified\"), Exists: false}\n"
	t += "	}\n"
	t += "	fieldsToSelect := params.Select\n"
	t += "	if len(fieldsToSelect) == 0 { fieldsToSelect = Fields }\n"
	t += "	whereFields := params.Where\n"
	t += "	if len(whereFields) == 0 { whereFields = Fields }\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(fieldsToSelect), \", \") + \" FROM \" + FQTN + \" WHERE \" + strings.Join(GetQualifiedFields(whereFields), \" = ? AND \") + \" = ? LIMIT 1\"\n"
	t += "	entities, err := queryCore(ctx, nil, fieldsToSelect, q, x.GetFieldsValues(whereFields)...)\n"
	t += "	if err != nil { return &QueryResult{Error: err, Exists: false} }\n"
	t += "	if len(entities) == 0 { return &QueryResult{Exists: false} }\n"
	t += "	*x = *entities[0]\n"
	t += "	return &QueryResult{Exists: true}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBExistsTx(tx *sql.Tx, params *QueryParams) *QueryResult {\n"
	t += "	if params == nil {\n"
	t += "		return &QueryResult{Error: errors.New(\"DBExists requires params to be specified\"), Exists: false}\n"
	t += "	}\n"
	t += "	fieldsToSelect := params.Select\n"
	t += "	if len(fieldsToSelect) == 0 { fieldsToSelect = Fields }\n"
	t += "	whereFields := params.Where\n"
	t += "	if len(whereFields) == 0 { whereFields = Fields }\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(fieldsToSelect), \", \") + \" FROM \" + FQTN + \" WHERE \" + strings.Join(GetQualifiedFields(whereFields), \" = ? AND \") + \" = ? LIMIT 1\"\n"
	t += "	entities, err := queryCore(nil, tx, fieldsToSelect, q, x.GetFieldsValues(whereFields)...)\n"
	t += "	if err != nil { return &QueryResult{Error: err, Exists: false} }\n"
	t += "	if len(entities) == 0 { return &QueryResult{Exists: false} }\n"
	t += "	*x = *entities[0]\n"
	t += "	return &QueryResult{Exists: true}\n"
	t += "}\n\n"
	t += "func (x *Entity) DBExistsCtxTx(ctx context.Context, tx *sql.Tx, params *QueryParams) *QueryResult {\n"
	t += "	if params == nil {\n"
	t += "		return &QueryResult{Error: errors.New(\"DBExists requires params to be specified\"), Exists: false}\n"
	t += "	}\n"
	t += "	fieldsToSelect := params.Select\n"
	t += "	if len(fieldsToSelect) == 0 { fieldsToSelect = Fields }\n"
	t += "	whereFields := params.Where\n"
	t += "	if len(whereFields) == 0 { whereFields = Fields }\n"
	t += "	q := \"SELECT \" + strings.Join(GetQualifiedFields(fieldsToSelect), \", \") + \" FROM \" + FQTN + \" WHERE \" + strings.Join(GetQualifiedFields(whereFields), \" = ? AND \") + \" = ? LIMIT 1\"\n"
	t += "	entities, err := queryCore(ctx, tx, fieldsToSelect, q, x.GetFieldsValues(whereFields)...)\n"
	t += "	if err != nil { return &QueryResult{Error: err, Exists: false} }\n"
	t += "	if len(entities) == 0 { return &QueryResult{Exists: false} }\n"
	t += "	*x = *entities[0]\n"
	t += "	return &QueryResult{Exists: true}\n"
	t += "}\n\n"



	return t
}

func GetNamedQueryFunctions(nqs []conf.NamedQuery) string {
	t := ""

	for _, nq := range nqs {
		mode := strings.ToLower(nq.Mode)
		if mode == "" {
			mode = "many"
		}
		hasParams := strings.Contains(nq.Query, "?")

		fieldsLit := "nil"
		if mode != "exec" {
			fs := make([]string, 0, len(nq.Returns))
			for _, r := range nq.Returns {
				fs = append(fs, "Field"+db.NormalizeString(r))
			}
			fieldsLit = "[]string{" + strings.Join(fs, ",") + "}"
		}

		// Helper to build function parameters
		buildParams := func(withCtx, withTx bool) string {
			var ps []string
			if withCtx {
				ps = append(ps, "ctx context.Context")
			}
			if withTx {
				ps = append(ps, "tx *sql.Tx")
			}
			if hasParams {
				ps = append(ps, "params *QueryParams")
			}
			if len(ps) == 0 {
				return "()"
			}
			return "(" + strings.Join(ps, ", ") + ")"
		}

		switch mode {
		case "exec":
			// core via execCore
			t += "func Exec" + nq.Name + buildParams(false, false) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; res, err := execCore(nil, nil, q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Result: res, Error: err} }\n"

			t += "func Exec" + nq.Name + "Ctx" + buildParams(true, false) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; res, err := execCore(ctx, nil, q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Result: res, Error: err} }\n"

			t += "func Exec" + nq.Name + "Tx" + buildParams(false, true) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; res, err := execCore(nil, tx, q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Result: res, Error: err} }\n"

			t += "func Exec" + nq.Name + "CtxTx" + buildParams(true, true) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; res, err := execCore(ctx, tx, q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Result: res, Error: err} }\n\n"

		case "one":
			// core uses queryOneCore for efficiency
			t += "func Query" + nq.Name + buildParams(false, false) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; entity, err := queryOneCore(nil, nil, " + fieldsLit + ", q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Entity: entity, Error: err, Exists: entity != nil} }\n"

			t += "func Query" + nq.Name + "Ctx" + buildParams(true, false) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; entity, err := queryOneCore(ctx, nil, " + fieldsLit + ", q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Entity: entity, Error: err, Exists: entity != nil} }\n"

			t += "func Query" + nq.Name + "Tx" + buildParams(false, true) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; entity, err := queryOneCore(nil, tx, " + fieldsLit + ", q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Entity: entity, Error: err, Exists: entity != nil} }\n"

			t += "func Query" + nq.Name + "CtxTx" + buildParams(true, true) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; entity, err := queryOneCore(ctx, tx, " + fieldsLit + ", q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Entity: entity, Error: err, Exists: entity != nil} }\n\n"

		default: // many
			t += "func Query" + nq.Name + buildParams(false, false) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; entities, err := queryCore(nil, nil, " + fieldsLit + ", q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Entities: entities, Error: err} }\n"

			t += "func Query" + nq.Name + "Ctx" + buildParams(true, false) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; entities, err := queryCore(ctx, nil, " + fieldsLit + ", q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Entities: entities, Error: err} }\n"

			t += "func Query" + nq.Name + "Tx" + buildParams(false, true) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; entities, err := queryCore(nil, tx, " + fieldsLit + ", q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Entities: entities, Error: err} }\n"

			t += "func Query" + nq.Name + "CtxTx" + buildParams(true, true) + " *QueryResult { q := queries[\"" + nq.Name + "\"]; entities, err := queryCore(ctx, tx, " + fieldsLit + ", q.Query"
			if hasParams {
				t += ", params.Params..."
			}
			t += "); return &QueryResult{Entities: entities, Error: err} }\n\n"
		}
	}

	return t
}
